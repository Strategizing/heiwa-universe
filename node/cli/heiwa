#!/Users/dmcgregsauce/heiwa/.venv/bin/python3
import argparse
import os
import json
import uuid
import subprocess
import sys
import shlex
from pathlib import Path

HEIWA_GLOBAL_DIR = Path(os.path.expanduser("~/.heiwa"))
IDENTITY_FILE = HEIWA_GLOBAL_DIR / "identity.json"
MONOREPO_ROOT = Path(__file__).resolve().parents[2]
NODE_ROOT = MONOREPO_ROOT / "node"
RUNTIME_ROOT = MONOREPO_ROOT / "runtime"


def _resolve_python() -> str:
    candidates = [
        MONOREPO_ROOT / ".venv313/bin/python",
        MONOREPO_ROOT / ".venv/bin/python",
    ]
    for candidate in candidates:
        if candidate.exists():
            return str(candidate)
    return sys.executable

def init_global_dir():
    HEIWA_GLOBAL_DIR.mkdir(parents=True, exist_ok=True)
    (HEIWA_GLOBAL_DIR / "workspace").mkdir(exist_ok=True)
    (HEIWA_GLOBAL_DIR / "context").mkdir(exist_ok=True)

def cmd_chat(args):
    """Launch the interactive Terminal Chat."""
    init_global_dir()
    python_bin = _resolve_python()
    chat_script = NODE_ROOT / "cli/scripts/terminal_chat.py"
    
    if not chat_script.exists():
        print("‚ùå Terminal chat script not found.")
        sys.exit(1)

    node_name = "devon-cli"
    if IDENTITY_FILE.exists():
        with open(IDENTITY_FILE, "r") as f:
            identity = json.load(f)
            node_name = identity.get("name", node_name)

    cmd = [python_bin, str(chat_script), node_name]
    subprocess.run(cmd)

def cmd_cost(args):
    """Show swarm-wide token usage and cost report."""
    print("üí∞ [HEIWA] Generating Swarm Cost Report...")
    # This will pull data from the central DB via TelemetryAgent or direct DB access
    python_bin = _resolve_python()
    report_script = NODE_ROOT / "cli/scripts/ops/cost_report.py"
    
    if not report_script.exists():
        # Fallback to simple DB query if script doesn't exist yet
        from runtime.libs.heiwa_sdk.db import Database
        db = Database()
        summary = db.get_model_usage_summary(minutes=1440) # Last 24h
        if not summary:
            print("   No usage data found for the last 24h.")
            return
        
        print(f"{'Model':<40} | {'Requests':<10} | {'Total Tokens':<12}")
        print("-" * 68)
        for row in summary:
            print(f"{row['model_id']:<40} | {row['request_count']:<10} | {row['total_tokens']:<12}")
    else:
        cmd = [python_bin, str(report_script)]
        subprocess.run(cmd)

def main():
    parser = argparse.ArgumentParser(description="Heiwa Enterprise CLI")
    subparsers = parser.add_subparsers(dest="command", help="Command to run")

    # chat (default)
    parser_chat = subparsers.add_parser("chat", help="Launch interactive swarm chat (Default)")
    
    # login
    parser_login = subparsers.add_parser("login", help="Authenticate and provision node identity")
    parser_login.add_argument("name", nargs="?", help="Human or Machine name for the identity")
    parser_login.add_argument("--force", action="store_true", help="Overwrite existing identity")

    # up
    parser_up = subparsers.add_parser("up", help="Start the local Heiwa instance")

    # doctor
    parser_doctor = subparsers.add_parser("doctor", help="Run operability and dependency checks")

    # deploy
    parser_deploy = subparsers.add_parser("deploy", help="Push the current matrix to Railway or Cloudflare")
    parser_deploy.add_argument("--edge", action="store_true", help="Deploy only edge WAF/DNS (Cloudflare)")
    parser_deploy.add_argument("--compute", action="store_true", help="Deploy only compute node (Railway)")
    parser_deploy.add_argument("--full", action="store_true", help="Deploy both edge and compute")

    # domains
    parser_domains = subparsers.add_parser("domains", help="Probe domain resolution and status")

    # cutover
    parser_cutover = subparsers.add_parser("run-cutover", help="Run automated domain cutover sequence")

    # provision
    parser_provision = subparsers.add_parser("provision-node", help="Prepare environment for a new swarm node")
    parser_provision.add_argument("node_id", help="Unique ID for the node (e.g. workstation)")
    parser_provision.add_argument("--node-type", default="heavy_compute", help="Type of hardware (mobile_node|heavy_compute)")

    # identity
    parser_identity = subparsers.add_parser(
        "identity",
        help="Resolve pre-programmed identity from conversation intent",
    )
    parser_identity.add_argument("text", help="Conversation/task text used for identity selection")
    parser_identity.add_argument("--json", action="store_true", help="Emit JSON output")

    # update
    parser_update = subparsers.add_parser("update", help="Auto-patch and update the Heiwa Swarm")

    # logout
    parser_logout = subparsers.add_parser("logout", help="Clear the local node identity")

    # status
    parser_status = subparsers.add_parser("status", help="Check swarm connectivity and node health")
    parser_status.add_argument("--full", action="store_true", help="Perform a swarm-wide telemetry probe")

    # cost
    parser_cost = subparsers.add_parser("cost", help="Show swarm-wide token usage and cost report")

    # research
    parser_research = subparsers.add_parser("research", help="Trigger a web research/scraping task")
    parser_research.add_argument("target", help="URL or topic to research")

    # audit
    parser_audit = subparsers.add_parser("audit", help="Run a self-improvement system audit")

    # If no command provided, default to chat
    if len(sys.argv) == 1:
        sys.argv.append("chat")

    args = parser.parse_args()

    if args.command == "chat":
        cmd_chat(args)
    elif args.command == "login":
        cmd_login(args)
    elif args.command == "up":
        cmd_up(args)
    elif args.command == "doctor":
        cmd_doctor(args)
    elif args.command == "deploy":
        cmd_deploy(args)
    elif args.command == "domains":
        cmd_domains(args)
    elif args.command == "run-cutover":
        cmd_cutover(args)
    elif args.command == "provision-node":
        cmd_provision(args)
    elif args.command == "identity":
        cmd_identity(args)
    elif args.command == "update":
        cmd_update(args)
    elif args.command == "logout":
        cmd_logout(args)
    elif args.command == "status":
        cmd_status(args)
    elif args.command == "cost":
        cmd_cost(args)
    elif args.command == "research":
        cmd_research(args)
    elif args.command == "audit":
        cmd_audit(args)

def cmd_research(args):
    """Trigger a web research task via NATS."""
    print(f"üîç [HEIWA] Initiating research task for: {args.target}")
    # We use a simple placeholder task ID until NATS publish wiring is added.
    task_id = f"research-{uuid.uuid4().hex[:8]}"
    print(f"üì° Task {task_id} published to mesh. Results will appear in #field-intel.")

def cmd_audit(args):
    """Run a local system audit."""
    print("üõ°Ô∏è [HEIWA] Running Machine Self-Improvement Audit...")
    python_bin = _resolve_python()
    audit_script = NODE_ROOT / "cli/scripts/ops/heiwa_360_check.py"
    if audit_script.exists():
        cmd = (
            f"cd {shlex.quote(str(MONOREPO_ROOT))} && "
            f"PYTHONPATH={shlex.quote(str(RUNTIME_ROOT))} "
            f"{shlex.quote(python_bin)} {shlex.quote(str(audit_script))}"
        )
        _run_subprocess(cmd)
    else:
        print("‚ùå Audit script not found in runtime.")

def cmd_status(args):
    """Check swarm connectivity and node health."""
    print("üõ∞Ô∏è [HEIWA] Probing Swarm Status...")
    
    # 1. Check Identity
    if IDENTITY_FILE.exists():
        with open(IDENTITY_FILE, "r") as f:
            identity = json.load(f)
        print(f"üë§ Identity: {identity.get('name')} ({identity.get('role')})")
    else:
        print("üë§ Identity: Not logged in.")

    # 2. Check NATS (Simple Ping)
    nats_url = os.getenv("NATS_URL", "nats://localhost:4222")
    print(f"üì° NATS Mesh: {nats_url}")
    
    # 3. Model-Centric Node Check
    print("\nüß† Active Model Instances (Local):")
    try:
        import requests
        resp = requests.get("http://localhost:11434/api/tags", timeout=2)
        if resp.status_code == 200:
            models = resp.json().get('models', [])
            for m in models:
                print(f"   - {m['name']} (Ready)")
        else:
            print("   - Ollama service unreachable")
    except:
        print("   - Ollama service unreachable")

    # 4. Local Resource Usage
    import psutil
    ram = psutil.virtual_memory().percent
    cpu = psutil.cpu_percent(interval=0.1)
    print(f"\nüìä Local Hardware Utilization:")
    print(f"   CPU: {cpu}%")
    print(f"   RAM: {ram}%")

    if args.full:
        print("\nüåê Swarm-wide Telemetry (Requesting from Mesh Brain)...")
        # Future: Add NATS request/reply logic here to fetch report from TelemetryAgent
        print("   (Feature coming in next sync: Live Mesh Report)")

def cmd_logout(args):
    """Clear the local node identity."""
    if IDENTITY_FILE.exists():
        os.remove(IDENTITY_FILE)
        print("üîí Logged out. Local identity cleared.")
    else:
        print("Already logged out.")

def cmd_update(args):
    """Trigger the auto-patcher and system update."""
    print("‚ú® [HEIWA] Initiating Swarm Self-Patching sequence...")
    # This will eventually trigger the auto_patcher script on the cloud or local node
    print(f"Checking for updates in {MONOREPO_ROOT}...")
    _run_subprocess(f"cd {shlex.quote(str(MONOREPO_ROOT))} && git pull --ff-only")
    print("‚úÖ System core updated. Running doctor to verify health...")
    cmd_doctor(args)

if __name__ == "__main__":
    main()
