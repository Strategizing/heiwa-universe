{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Heiwa Net Request v2",
  "description": "Schema for controlled internet access requests routed through the Heiwa net policy proxy. All automated internet traffic from agents/runtime should be wrapped in this envelope for policy evaluation.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "request_id",
    "created_at",
    "origin",
    "destination",
    "method",
    "purpose",
    "risk_class",
    "requires_approval"
  ],
  "properties": {
    "schema_version": {
      "const": "heiwa_net_request_v2"
    },
    "request_id": {
      "type": "string",
      "description": "Unique request identifier (UUID)"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of request creation"
    },
    "origin": {
      "type": "object",
      "required": ["surface", "agent_id"],
      "additionalProperties": true,
      "properties": {
        "surface": {
          "type": "string",
          "enum": ["runtime", "agent", "cli", "cron", "cloud-hq"],
          "description": "Which execution surface initiated this request"
        },
        "agent_id": {
          "type": ["string", "null"],
          "description": "Agent identifier if originated by an agent"
        },
        "device_id": {
          "type": ["string", "null"],
          "description": "Device identifier from the device registry"
        },
        "tenant_id": {
          "type": ["string", "null"],
          "description": "Tenant identifier"
        }
      }
    },
    "destination": {
      "type": "object",
      "required": ["url"],
      "additionalProperties": true,
      "properties": {
        "url": {
          "type": "string",
          "description": "Target URL for the request"
        },
        "host": {
          "type": ["string", "null"],
          "description": "Extracted hostname for policy matching"
        },
        "port": {
          "type": ["integer", "null"],
          "description": "Port number if non-standard"
        },
        "protocol": {
          "type": "string",
          "enum": ["https", "http", "wss", "ws", "nats"],
          "description": "Protocol for the request"
        }
      }
    },
    "method": {
      "type": "string",
      "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS", "CONNECT", "SUBSCRIBE", "PUBLISH"],
      "description": "HTTP method or message bus operation"
    },
    "purpose": {
      "type": "string",
      "description": "Human-readable purpose for the request (used in audit trail)"
    },
    "purpose_class": {
      "type": "string",
      "enum": [
        "api_auth",
        "api_data_read",
        "api_data_write",
        "api_deploy",
        "webhook_delivery",
        "health_check",
        "model_inference",
        "search",
        "scrape",
        "file_download",
        "dns_lookup",
        "messaging",
        "other"
      ],
      "description": "Classified purpose for policy routing"
    },
    "risk_class": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "description": "Risk classification based on destination, method, and purpose"
    },
    "requires_approval": {
      "type": "boolean",
      "description": "Whether this request requires human approval before execution"
    },
    "approval_ref": {
      "type": ["string", "null"],
      "description": "Reference to an approval decision if pre-approved"
    },
    "headers_redacted": {
      "type": "boolean",
      "default": true,
      "description": "Whether sensitive headers have been redacted in this envelope"
    },
    "body_hash": {
      "type": ["string", "null"],
      "description": "SHA-256 of the request body for audit (body content is NOT stored in the envelope)"
    },
    "timeout_ms": {
      "type": ["integer", "null"],
      "description": "Request timeout in milliseconds"
    },
    "retry_policy": {
      "type": ["string", "null"],
      "enum": ["none", "once", "exponential", null],
      "description": "Retry policy for transient failures"
    }
  }
}
